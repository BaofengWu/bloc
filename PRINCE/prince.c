#include <stdint.h>
#include "tools.h"

#define ALPHA 0xc0ac29b7c97c50dd

typedef uint8_t u8;
typedef uint32_t u32;
typedef uint64_t u64;

static const u8 sBox[16] =
{0xb,0xf,0x3,0x2,0xa,0xc,0x9,0x1,
0x6,0x7,0x8,0x0,0xe,0x5,0xd,0x4};

static const u8 sBoxInv[16] =
{0xb,0x7,0x3,0x2,0xf,0xd,0x8,0x9,
0xa,0x6,0x4,0x0,0x5,0xe,0xc,0x1};

static const u64 RC[12] = {
0x0000000000000000,
0x13198a2e03707344,
0xa4093822299f31d0,
0x082efa98ec4e6c89,
0x452821e638d01377,
0xbe5466cf34e90c6c,
0x7ef84f78fd955cb1,
0x85840851f1ac43aa,
0xc882d32f25323c54,
0x64a51195e0e3610d,
0xd3b5a399ca0c2399,
0xc0ac29b7c97c50dd};

static const u64 MPrime[64] =
{
	0x0888000000000000,
	0x4044000000000000,
	0x2202000000000000,
	0x1110000000000000,
	0x8880000000000000,
	0x0444000000000000,
	0x2022000000000000,
	0x1101000000000000,
	0x8808000000000000,
	0x4440000000000000,
	0x0222000000000000,
	0x1011000000000000,
	0x8088000000000000,
	0x4404000000000000,
	0x2220000000000000,
	0x0111000000000000,
	0x0000888000000000,
	0x0000044400000000,
	0x0000202200000000,
	0x0000110100000000,
	0x0000880800000000,
	0x0000444000000000,
	0x0000022200000000,
	0x0000101100000000,
	0x0000808800000000,
	0x0000440400000000,
	0x0000222000000000,
	0x0000011100000000,
	0x0000088800000000,
	0x0000404400000000,
	0x0000220200000000,
	0x0000111000000000,
	0x0000000088800000,
	0x0000000004440000,
	0x0000000020220000,
	0x0000000011010000,
	0x0000000088080000,
	0x0000000044400000,
	0x0000000002220000,
	0x0000000010110000,
	0x0000000080880000,
	0x0000000044040000,
	0x0000000022200000,
	0x0000000001110000,
	0x0000000008880000,
	0x0000000040440000,
	0x0000000022020000,
	0x0000000011100000,
	0x0000000000000888,
	0x0000000000004044,
	0x0000000000002202,
	0x0000000000001110,
	0x0000000000008880,
	0x0000000000000444,
	0x0000000000002022,
	0x0000000000001101,
	0x0000000000008808,
	0x0000000000004440,
	0x0000000000000222,
	0x0000000000001011,
	0x0000000000008088,
	0x0000000000004404,
	0x0000000000002220,
	0x0000000000000111
};

static const u64 M[64] =
{
	0x0888000000000000,
	0x4044000000000000,
	0x2202000000000000,
	0x1110000000000000,
	0x0000880800000000,
	0x0000444000000000,
	0x0000022200000000,
	0x0000101100000000,
	0x0000000080880000,
	0x0000000044040000,
	0x0000000022200000,
	0x0000000001110000,
	0x0000000000008088,
	0x0000000000004404,
	0x0000000000002220,
	0x0000000000000111,
	0x0000888000000000,
	0x0000044400000000,
	0x0000202200000000,
	0x0000110100000000,
	0x0000000088080000,
	0x0000000044400000,
	0x0000000002220000,
	0x0000000010110000,
	0x0000000000008808,
	0x0000000000004440,
	0x0000000000000222,
	0x0000000000001011,
	0x8088000000000000,
	0x4404000000000000,
	0x2220000000000000,
	0x0111000000000000,
	0x0000000088800000,
	0x0000000004440000,
	0x0000000020220000,
	0x0000000011010000,
	0x0000000000008880,
	0x0000000000000444,
	0x0000000000002022,
	0x0000000000001101,
	0x8808000000000000,
	0x4440000000000000,
	0x0222000000000000,
	0x1011000000000000,
	0x0000088800000000,
	0x0000404400000000,
	0x0000220200000000,
	0x0000111000000000,
	0x0000000000000888,
	0x0000000000004044,
	0x0000000000002202,
	0x0000000000001110,
	0x8880000000000000,
	0x0444000000000000,
	0x2022000000000000,
	0x1101000000000000,
	0x0000808800000000,
	0x0000440400000000,
	0x0000222000000000,
	0x0000011100000000,
	0x0000000008880000,
	0x0000000040440000,
	0x0000000022020000,
	0x0000000011100000
};

static const u64 MInv[64] =
{
	0x0000000800800800,
	0x4000000400400000,
	0x2000000200000200,
	0x1000000000100100,
	0x8000000000800800,
	0x0000000400400400,
	0x2000000200200000,
	0x1000000100000100,
	0x8000000800000800,
	0x4000000000400400,
	0x0000000200200200,
	0x1000000100100000,
	0x8000000800800000,
	0x4000000400000400,
	0x2000000000200200,
	0x0000000100100100,
	0x0800800000000080,
	0x0400000000040040,
	0x0000200000020020,
	0x0100100000010000,
	0x0800800000080000,
	0x0400400000000040,
	0x0200000000020020,
	0x0000100000010010,
	0x0000800000080080,
	0x0400400000040000,
	0x0200200000000020,
	0x0100000000010010,
	0x0800000000080080,
	0x0000400000040040,
	0x0200200000020000,
	0x0100100000000010,
	0x0080080080000000,
	0x0040040000000004,
	0x0020000020000002,
	0x0000010010000001,
	0x0000080080000008,
	0x0040040040000000,
	0x0020020000000002,
	0x0010000010000001,
	0x0080000080000008,
	0x0000040040000004,
	0x0020020020000000,
	0x0010010000000001,
	0x0080080000000008,
	0x0040000040000004,
	0x0000020020000002,
	0x0010010010000000,
	0x0008008008000000,
	0x0004004000004000,
	0x0002000002002000,
	0x0000001001001000,
	0x0000008008008000,
	0x0004004004000000,
	0x0002002000002000,
	0x0001000001001000,
	0x0008000008008000,
	0x0000004004004000,
	0x0002002002000000,
	0x0001001000001000,
	0x0008008000008000,
	0x0004000004004000,
	0x0000002002002000,
	0x0001001001000000
};

void Substitution (u64 * block, u8 sbox[])
{
    u8 i;
    u64 mask = 0xf;

    for (i=0 ; i<16 ; i++)
    {
        *block = (*block & (~mask)) | ((u64)(sbox[(*block & mask) >> (i<<2)]) << (i<<2));
        mask = mask << 4;
    }
}

u64 Parity (u64 block)
{
    block = (block >> 32) ^ block;
    block = (block >> 16) ^ block;
    block = (block >> 8) ^ block;
    block = (block >> 4) ^ block;
    block = (block >> 2) ^ block;
    block = (block >> 1) ^ block;
    return block & 0x1;
}

void MatrixMul (u64 * block, u64 matrix[])
{
    u64 tmp = 0;
	u8 r;
	for (r = 0; r < 64; r++)
	{
		tmp |= Parity(*block & matrix[r]) << (63-r);
	}
	*block = tmp;
}


void Encrypt(u64 k[], u64 * block)
{
    u8 i;
    u64 k1 = k[1];

    *block = *block ^ k[0];


    *block = *block ^ k1 ^ RC[0];
    for (i=1;i<6;i++)
    {
        Substitution(block,sBox);
        MatrixMul(block,M);
        *block = *block ^ k1 ^ RC[i];
    }
    Substitution(block,sBox);
    MatrixMul(block,MPrime);
    Substitution(block,sBoxInv);
    for (i=6;i<11;i++)
    {
        *block = *block ^ k1 ^ RC[i];
        MatrixMul(block,MInv);
        Substitution(block,sBoxInv);
    }
    *block = *block ^ k1 ^ RC[11];

    *block = *block ^ ROTATE_RIGHT_64(k[0],1) ^ (k[0] >> 63);
}


void Decrypt(u64 k[], u64 * block)
{
    u8 i;
    u64 k1 = k[1] ^ ALPHA;

    *block = *block ^ ROTATE_RIGHT_64(k[0],1) ^ (k[0] >> 63);

    *block = *block ^ k1 ^ RC[0];
    for (i=1;i<6;i++)
    {
        Substitution(block,sBox);
        MatrixMul(block,M);
        *block = *block ^ k1 ^ RC[i];
    }
    Substitution(block,sBox);
    MatrixMul(block,MPrime);
    Substitution(block,sBoxInv);
    for (i=6;i<11;i++)
    {
        *block = *block ^ k1 ^ RC[i];
        MatrixMul(block,MInv);
        Substitution(block,sBoxInv);
    }
    *block = *block ^ k1 ^ RC[11];

    *block = *block ^ k[0];
}




int main()
{
    u64 k[2] = {0x0,0xfedcba9876543210};
    u64 t = 0x0123456789abcdef;

	START_ENCRYPT();
    Encrypt(k,&t);
    //printf("%llx\n\n",t);
	START_DECRYPT();
    Decrypt(k,&t);
    //printf("%llx\n\n",t);
	END_EXPE();
    return 0;
}
